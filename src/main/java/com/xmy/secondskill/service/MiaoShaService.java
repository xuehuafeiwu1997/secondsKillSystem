package com.xmy.secondskill.service;import com.xmy.secondskill.entity.MiaoshaOrder;import com.xmy.secondskill.entity.OrderInfo;import com.xmy.secondskill.entity.User;import com.xmy.secondskill.redis.MiaoshaKey;import com.xmy.secondskill.redis.RedisService;import com.xmy.secondskill.vo.GoodsVo;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.stereotype.Service;import java.util.List;/** * @author xmy * @date 2021/3/28 1:20 下午 */@Servicepublic class MiaoShaService {    @Autowired    GoodsService goodsService;    @Autowired    OrderService orderService;    @Autowired    RedisService redisService;    public OrderInfo miaosha(User user, GoodsVo goods) {        //减库存，下订单，写入秒杀订单        boolean success = goodsService.reduceGoods(goods);        if (success) {            //创建订单            return orderService.createOrder(user,goods);        } else {            setGoodsOver(goods.getId());            return null;        }    }    public long getMiaoShaResult(Long userId, long goodsId) {        MiaoshaOrder order = orderService.getMiaoShaOrderByUserIdAndGoodsId(userId,goodsId);        if (order != null) {            return order.getOrderId();        } else {            boolean isOver = getGoodsOver(goodsId);            if (isOver) {                return -1;            } else {                return 0;            }        }    }    private boolean getGoodsOver(long goodsId) {        return redisService.exists(MiaoshaKey.isGoodsOver,""+goodsId);    }    private void setGoodsOver(long goodsId) {        redisService.set(MiaoshaKey.isGoodsOver,""+goodsId,true);    }    public void reset(List<GoodsVo> goodsList) {        goodsService.resetStock(goodsList);        orderService.deleteOrders();    }}